name: Build Android ARM64 Nginx

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: [ 'src/**', 'auto/**', 'conf/**' ] # å½“æ ¸å¿ƒä»£ç å˜æ›´æ—¶è§¦å‘

jobs:
  build-android-nginx:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential automake libtool unzip
        
    - name: Download Android NDK
      run: |
        # ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„ NDK
        NDK_VERSION="25.2.9519653"
        NDK_ZIP="android-ndk-r${NDK_VERSION}-linux.zip"
        wget https://dl.google.com/android/repository/${NDK_ZIP}
        unzip -q ${NDK_ZIP} -d /usr/local/lib
        echo "NDK_ROOT=/usr/local/lib/android-ndk-r${NDK_VERSION}" >> $GITHUB_ENV
        echo "NDK_VERSION=${NDK_VERSION}" >> $GITHUB_ENV
        rm ${NDK_ZIP}

    - name: Configure build parameters
      id: config
      run: |
        # è®¾ç½®æ¶æ„å‚æ•°
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "TRIPLE=aarch64-linux-android" >> $GITHUB_ENV
        echo "API_LEVEL=21" >> $GITHUB_ENV
        echo "CPU=armv8-a" >> $GITHUB_ENV
        
        # è®¾ç½®å·¥å…·é“¾è·¯å¾„
        TOOLCHAIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "CC=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang++" >> $GITHUB_ENV
        echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
        
        # è®¾ç½®ç¼–è¯‘æ ‡å¿—
        echo "CFLAGS=-target ${TRIPLE} -march=$CPU -Os -fPIE -fPIC" >> $GITHUB_ENV
        echo "LDFLAGS=-target ${TRIPLE} -pie" >> $GITHUB_ENV

    - name: Configure Nginx
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir build-${{ env.ARCH }}
        cd build-${{ env.ARCH }}
        
        # è¿è¡Œé…ç½®
        ../auto/configure \
          --prefix=/ \
          --sbin-path=nginx \
          --conf-path=conf/nginx.conf \
          --error-log-path=logs/error.log \
          --pid-path=logs/nginx.pid \
          --http-log-path=logs/access.log \
          --with-http_ssl_module \
          --with-http_gzip_static_module \
          --with-threads \
          --with-cc="${{ env.CC }}" \
          --with-cc-opt="${{ env.CFLAGS }}" \
          --with-ld-opt="${{ env.LDFLAGS }}" \
          --without-http_rewrite_module \
          --without-mail
        
        # ä¿å­˜é…ç½®æ—¥å¿—
        cp objs/autoconf.err ../config.log

    - name: Build Nginx
      run: |
        cd build-${{ env.ARCH }}
        make -j $(nproc) # ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒç¼–è¯‘

    - name: Prepare artifacts
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p android-nginx-arm64/{conf,logs,html}
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp build-${{ env.ARCH }}/objs/nginx android-nginx-arm64/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp conf/nginx.conf android-nginx-arm64/conf/
        cp conf/mime.types android-nginx-arm64/conf/
        
        # åˆ›å»ºæµ‹è¯•é¡µé¢
        cat << EOF > android-nginx-arm64/html/index.html
        <!DOCTYPE html>
        <html>
        <head>
            <title>Nginx on Android</title>
        </head>
        <body>
            <h1>Nginx (ARM64) Running on Android!</h1>
            <p>Built with GitHub Actions at $(date)</p>
        </body>
        </html>
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat << 'EOF' > android-nginx-arm64/start-nginx.sh
        #!/system/bin/sh
        
        # è®¾ç½®ç¯å¢ƒ
        SCRIPT_DIR="$(dirname "$0")"
        export PATH="$SCRIPT_DIR:$PATH"
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p $SCRIPT_DIR/logs
        
        # å¯åŠ¨ Nginx
        echo "ğŸš€ Starting Nginx (ARM64)..."
        nginx -p $SCRIPT_DIR -c $SCRIPT_DIR/conf/nginx.conf
        
        # æ£€æŸ¥çŠ¶æ€
        if [ $? -eq 0 ]; then
            echo "âœ… Nginx started successfully (PID: $(cat $SCRIPT_DIR/logs/nginx.pid))"
            echo "ğŸŒ Access: http://localhost:8080"
        else
            echo "âŒ Nginx failed to start!"
            cat $SCRIPT_DIR/logs/error.log
        fi
        EOF
        
        chmod +x android-nginx-arm64/start-nginx.sh
        
        # å‹ç¼©è¾“å‡º
        tar czf android-nginx-arm64.tar.gz android-nginx-arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-nginx-arm64
        path: |
          android-nginx-arm64.tar.gz
          config.log

    - name: Create release
      if: github.ref == 'refs/heads/main' # ä»…åœ¨ main åˆ†æ”¯åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: android-nginx-arm64.tar.gz
        tag_name: android-arm64-$(date +%Y%m%d%H%M)
        name: "Android ARM64 Nginx Build"
        body: |
          ### Android ARM64 Nginx Build
          - Built on: $(date)
          - Commit: ${{ github.sha }}
          - Nginx Version: $(grep '^NGINX_VERSION=' auto/configure | cut -d= -f2)
          - NDK Version: ${{ env.NDK_VERSION }}
