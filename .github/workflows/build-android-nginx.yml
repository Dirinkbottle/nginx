name: Build Android ARM64 Nginx

on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ main ]
    paths: [ 'src/**', 'auto/**', 'conf/**' ] # 当核心代码变更时触发

jobs:
  build-android-nginx:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # 设置超时时间

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive # 确保检出所有子模块
        fetch-depth: 0 # 获取完整历史记录

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential automake libtool unzip
        
    - name: Cache Android NDK
      id: cache-ndk
      uses: actions/cache@v3
      with:
        path: android-ndk-r27c
        key: ndk-r27c-cache
        
    - name: Download and extract Android NDK r27c
      if: steps.cache-ndk.outputs.cache-hit != 'true'
      run: |
        # 使用指定镜像下载固定版本的 NDK
        NDK_VERSION="r27c"
        NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
        NDK_URL="https://googledownloads.cn/android/repository/${NDK_ZIP}"
        
        echo "📥 下载 Android NDK ${NDK_VERSION}..."
        wget $NDK_URL
        
        echo "📦 解压 NDK..."
        unzip -q $NDK_ZIP
        rm $NDK_ZIP
        
        # 验证解压结果
        if [ ! -d "android-ndk-${NDK_VERSION}" ]; then
          echo "❌ NDK 解压失败！"
          exit 1
        fi

    - name: Set NDK environment
      run: |
        # 设置环境变量
        echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r27c" >> $GITHUB_ENV
        echo "NDK_VERSION=r27c" >> $GITHUB_ENV
        
        # 确保目录名称一致
        if [ -d "android-ndk-r27c" ]; then
          echo "✅ 使用缓存的 NDK: $GITHUB_WORKSPACE/android-ndk-r27c"
        elif [ -d "android-ndk-${NDK_VERSION}" ]; then
          # 重命名目录以匹配缓存路径
          mv "android-ndk-${NDK_VERSION}" "android-ndk-r27c"
          echo "✅ 使用新下载的 NDK: $GITHUB_WORKSPACE/android-ndk-r27c"
        else
          echo "❌ NDK 目录未找到！"
          exit 1
        fi

    - name: Configure build parameters
      run: |
        # 设置架构参数
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "TRIPLE=aarch64-linux-android" >> $GITHUB_ENV
        echo "API_LEVEL=21" >> $GITHUB_ENV
        echo "CPU=armv8-a" >> $GITHUB_ENV
        
        # 设置工具链路径
        TOOLCHAIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "CC=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang++" >> $GITHUB_ENV
        echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
        
        # 设置编译标志
        echo "CFLAGS=-target ${TRIPLE} -march=$CPU -Os -fPIE -fPIC" >> $GITHUB_ENV
        echo "LDFLAGS=-target ${TRIPLE} -pie" >> $GITHUB_ENV

    - name: Verify repository structure
      run: |
        # 检查必要的文件和目录是否存在
        echo "🔍 验证仓库结构..."
        required_files=("auto/configure" "auto/options" "src/core/nginx.c")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ 文件不存在: $file"
            exit 1
          fi
        done
        echo "✅ 仓库结构验证通过"

    - name: Configure Nginx
      run: |
        # 创建构建目录
        mkdir build-${{ env.ARCH }}
        cd build-${{ env.ARCH }}
        
        # 使用绝对路径运行配置
        $GITHUB_WORKSPACE/auto/configure \
          --prefix=/ \
          --sbin-path=nginx \
          --conf-path=conf/nginx.conf \
          --error-log-path=logs/error.log \
          --pid-path=logs/nginx.pid \
          --http-log-path=logs/access.log \
          --with-http_ssl_module \
          --with-http_gzip_static_module \
          --with-threads \
          --with-cc="${{ env.CC }}" \
          --with-cc-opt="${{ env.CFLAGS }}" \
          --with-ld-opt="${{ env.LDFLAGS }}" \
          --without-http_rewrite_module \
          --without-mail
        
        # 保存配置日志
        cp objs/autoconf.err ../config.log

    - name: Build Nginx
      run: |
        cd build-${{ env.ARCH }}
        make -j $(nproc) # 使用所有可用核心编译

    - name: Prepare artifacts
      run: |
        # 创建输出目录
        mkdir -p android-nginx-arm64/{conf,logs,html}
        
        # 复制二进制文件
        cp build-${{ env.ARCH }}/objs/nginx android-nginx-arm64/
        
        # 复制配置文件
        cp conf/nginx.conf android-nginx-arm64/conf/
        cp conf/mime.types android-nginx-arm64/conf/
        
        # 创建测试页面
        cat << EOF > android-nginx-arm64/html/index.html
        <!DOCTYPE html>
        <html>
        <head>
            <title>Nginx on Android</title>
        </head>
        <body>
            <h1>Nginx (ARM64) Running on Android!</h1>
            <p>Built with GitHub Actions at $(date)</p>
            <p>NDK Version: ${{ env.NDK_VERSION }}</p>
        </body>
        </html>
        EOF
        
        # 创建启动脚本
        cat << 'EOF' > android-nginx-arm64/start-nginx.sh
        #!/system/bin/sh
        
        # 设置环境
        SCRIPT_DIR="$(dirname "$0")"
        export PATH="$SCRIPT_DIR:$PATH"
        
        # 创建日志目录
        mkdir -p $SCRIPT_DIR/logs
        
        # 启动 Nginx
        echo "🚀 Starting Nginx (ARM64)..."
        nginx -p $SCRIPT_DIR -c $SCRIPT_DIR/conf/nginx.conf
        
        # 检查状态
        if [ $? -eq 0 ]; then
            echo "✅ Nginx started successfully (PID: $(cat $SCRIPT_DIR/logs/nginx.pid))"
            echo "🌐 Access: http://localhost:8080"
        else
            echo "❌ Nginx failed to start!"
            cat $SCRIPT_DIR/logs/error.log
        fi
        EOF
        
        chmod +x android-nginx-arm64/start-nginx.sh
        
        # 压缩输出
        tar czf android-nginx-arm64.tar.gz android-nginx-arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-nginx-arm64
        path: |
          android-nginx-arm64.tar.gz
          config.log

    - name: Create release
      if: github.ref == 'refs/heads/main' # 仅在 main 分支创建发布
      uses: softprops/action-gh-release@v1
      with:
        files: android-nginx-arm64.tar.gz
        tag_name: android-arm64-$(date +%Y%m%d%H%M)
        name: "Android ARM64 Nginx Build"
        body: |
          ### Android ARM64 Nginx Build
          - Built on: $(date)
          - Commit: ${{ github.sha }}
          - Nginx Version: $(grep '^NGINX_VERSION=' auto/configure | cut -d= -f2)
          - NDK Version: ${{ env.NDK_VERSION }}
