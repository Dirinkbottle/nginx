name: Build Android ARM64 Nginx

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: [ 'src/**', 'auto/**', 'conf/**' ] # å½“æ ¸å¿ƒä»£ç å˜æ›´æ—¶è§¦å‘

jobs:
  build-android-nginx:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive # ç¡®ä¿æ£€å‡ºæ‰€æœ‰å­æ¨¡å—
        fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential automake libtool unzip
        
    - name: Cache Android NDK
      id: cache-ndk
      uses: actions/cache@v3
      with:
        path: android-ndk-r27c
        key: ndk-r27c-cache
        
    - name: Download and extract Android NDK r27c
      if: steps.cache-ndk.outputs.cache-hit != 'true'
      run: |
        # ä½¿ç”¨æŒ‡å®šé•œåƒä¸‹è½½å›ºå®šç‰ˆæœ¬çš„ NDK
        NDK_VERSION="r27c"
        NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
        NDK_URL="https://googledownloads.cn/android/repository/${NDK_ZIP}"
        
        echo "ğŸ“¥ ä¸‹è½½ Android NDK ${NDK_VERSION}..."
        wget $NDK_URL
        
        echo "ğŸ“¦ è§£å‹ NDK..."
        unzip -q $NDK_ZIP
        rm $NDK_ZIP
        
        # éªŒè¯è§£å‹ç»“æœ
        if [ ! -d "android-ndk-${NDK_VERSION}" ]; then
          echo "âŒ NDK è§£å‹å¤±è´¥ï¼"
          exit 1
        fi

    - name: Set NDK environment
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r27c" >> $GITHUB_ENV
        echo "NDK_VERSION=r27c" >> $GITHUB_ENV
        
        # ç¡®ä¿ç›®å½•åç§°ä¸€è‡´
        if [ -d "android-ndk-r27c" ]; then
          echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ NDK: $GITHUB_WORKSPACE/android-ndk-r27c"
        elif [ -d "android-ndk-${NDK_VERSION}" ]; then
          # é‡å‘½åç›®å½•ä»¥åŒ¹é…ç¼“å­˜è·¯å¾„
          mv "android-ndk-${NDK_VERSION}" "android-ndk-r27c"
          echo "âœ… ä½¿ç”¨æ–°ä¸‹è½½çš„ NDK: $GITHUB_WORKSPACE/android-ndk-r27c"
        else
          echo "âŒ NDK ç›®å½•æœªæ‰¾åˆ°ï¼"
          exit 1
        fi

    - name: Configure build parameters
      run: |
        # è®¾ç½®æ¶æ„å‚æ•°
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "TRIPLE=aarch64-linux-android" >> $GITHUB_ENV
        echo "API_LEVEL=21" >> $GITHUB_ENV
        echo "CPU=armv8-a" >> $GITHUB_ENV
        
        # è®¾ç½®å·¥å…·é“¾è·¯å¾„
        TOOLCHAIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        echo "CC=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/${TRIPLE}${API_LEVEL}-clang++" >> $GITHUB_ENV
        echo "AR=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$TOOLCHAIN/llvm-ranlib" >> $GITHUB_ENV
        
        # è®¾ç½®ç¼–è¯‘æ ‡å¿—
        echo "CFLAGS=-target ${TRIPLE} -march=$CPU -Os -fPIE -fPIC" >> $GITHUB_ENV
        echo "LDFLAGS=-target ${TRIPLE} -pie" >> $GITHUB_ENV

    - name: Verify repository structure
      run: |
        # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•æ˜¯å¦å­˜åœ¨
        echo "ğŸ” éªŒè¯ä»“åº“ç»“æ„..."
        required_files=("auto/configure" "auto/options" "src/core/nginx.c")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            exit 1
          fi
        done
        echo "âœ… ä»“åº“ç»“æ„éªŒè¯é€šè¿‡"

    - name: Configure Nginx
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir build-${{ env.ARCH }}
        cd build-${{ env.ARCH }}
        
        # ä½¿ç”¨ç»å¯¹è·¯å¾„è¿è¡Œé…ç½®
        $GITHUB_WORKSPACE/auto/configure \
          --prefix=/ \
          --sbin-path=nginx \
          --conf-path=conf/nginx.conf \
          --error-log-path=logs/error.log \
          --pid-path=logs/nginx.pid \
          --http-log-path=logs/access.log \
          --with-http_ssl_module \
          --with-http_gzip_static_module \
          --with-threads \
          --with-cc="${{ env.CC }}" \
          --with-cc-opt="${{ env.CFLAGS }}" \
          --with-ld-opt="${{ env.LDFLAGS }}" \
          --without-http_rewrite_module \
          --without-mail
        
        # ä¿å­˜é…ç½®æ—¥å¿—
        cp objs/autoconf.err ../config.log

    - name: Build Nginx
      run: |
        cd build-${{ env.ARCH }}
        make -j $(nproc) # ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒç¼–è¯‘

    - name: Prepare artifacts
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p android-nginx-arm64/{conf,logs,html}
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp build-${{ env.ARCH }}/objs/nginx android-nginx-arm64/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp conf/nginx.conf android-nginx-arm64/conf/
        cp conf/mime.types android-nginx-arm64/conf/
        
        # åˆ›å»ºæµ‹è¯•é¡µé¢
        cat << EOF > android-nginx-arm64/html/index.html
        <!DOCTYPE html>
        <html>
        <head>
            <title>Nginx on Android</title>
        </head>
        <body>
            <h1>Nginx (ARM64) Running on Android!</h1>
            <p>Built with GitHub Actions at $(date)</p>
            <p>NDK Version: ${{ env.NDK_VERSION }}</p>
        </body>
        </html>
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat << 'EOF' > android-nginx-arm64/start-nginx.sh
        #!/system/bin/sh
        
        # è®¾ç½®ç¯å¢ƒ
        SCRIPT_DIR="$(dirname "$0")"
        export PATH="$SCRIPT_DIR:$PATH"
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p $SCRIPT_DIR/logs
        
        # å¯åŠ¨ Nginx
        echo "ğŸš€ Starting Nginx (ARM64)..."
        nginx -p $SCRIPT_DIR -c $SCRIPT_DIR/conf/nginx.conf
        
        # æ£€æŸ¥çŠ¶æ€
        if [ $? -eq 0 ]; then
            echo "âœ… Nginx started successfully (PID: $(cat $SCRIPT_DIR/logs/nginx.pid))"
            echo "ğŸŒ Access: http://localhost:8080"
        else
            echo "âŒ Nginx failed to start!"
            cat $SCRIPT_DIR/logs/error.log
        fi
        EOF
        
        chmod +x android-nginx-arm64/start-nginx.sh
        
        # å‹ç¼©è¾“å‡º
        tar czf android-nginx-arm64.tar.gz android-nginx-arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-nginx-arm64
        path: |
          android-nginx-arm64.tar.gz
          config.log

    - name: Create release
      if: github.ref == 'refs/heads/main' # ä»…åœ¨ main åˆ†æ”¯åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: android-nginx-arm64.tar.gz
        tag_name: android-arm64-$(date +%Y%m%d%H%M)
        name: "Android ARM64 Nginx Build"
        body: |
          ### Android ARM64 Nginx Build
          - Built on: $(date)
          - Commit: ${{ github.sha }}
          - Nginx Version: $(grep '^NGINX_VERSION=' auto/configure | cut -d= -f2)
          - NDK Version: ${{ env.NDK_VERSION }}
